---
author: "Phong Duong - 100500507"
title: "Data Science II - Assignment"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(data.table)
library(tidyverse)
library(DataExplorer)
```

# Problem description

In our cities, there are some services that are essential for our daily living: **pharmacies, schools or transport points of sale.** However, these facilities are not necessarily well distributed. We want to analyze in this assignment which areas lacks of these facilities based on regression models. The steps to perform the analysis are:

-   Do a descriptive analysis of data
-   Are there variables we can discard?
-   Perform a feature engineering process extending important variables.
-   Perform regression modelling for the three target variables (three different models).
-   Create a score to measure **which areas** have enough facilities and which ones don't.
-   Which variables are the most highly related to the score? In particular, what makes a census section to have a low number of facilities?
-   Visualize and discuss the results

# Dataset description

```{r}
df<-fread("census_section_stats.csv", sep=";", dec=",", stringsAsFactors = F)
head(df)
```

For every census section we have a row in our dataset, here are some of the main columns of the dataset: \* census_section_code: census_section_code identifier \* n_pharmacies (target variable 1): number of pharmacies in the census section \* n_schools (target variable 2): number of schools in the census section \* n_transport_salespoints: number of transport points of sale.

# Descriptive analysis

## Data Exploration

### Brief Check of overall data

```{r}
str(df)
summary(df)
```

-   No missing values in the data.

-   census codes are integers --\> change to chr + factor

-   race/nationality --\> pivot longer ?

-   pcg_age --\> pivot longer ?

```{r}
#Convert to appropriate data type
df <- df %>% 
  mutate(
    census_section_code = as.character(census_section_code),
    census_district_code = as.character(census_district_code),
    city_code = as.character(city_code),
    province_code = as.character(province_code)
  )
```

### **Target variables**

-   Pharmacy - each census on average has 1 pharmacy, max = 5 --\> check if income affects this

-   School - each census has around 1 school, max = 12 --\> check these high values

-   transport - seems like many censuses lack sales points --\> geography might affect this?

```{r}
target_vars <- df %>% 
  select(n_pharmacies, n_schools, n_transport_salespoints)

summary(target_vars)
```

The average number of **pharmacies** in each census is 0.66 (median = 1) with range of 0 to 5. The average number of **schools** in each census is 0.91 (median = 0) and there are anywhere between 0 and 12 school in the censuses. The average number of number of **transport POS** is 0.27 (median = 0) and range from 0 to 4.

It seems that about 50% of the censuses lack a pharmacy, school, and transport sales point, meaning that people living in these censuses would have to go to another location to get access to these services. Some censuses, however, have an excess of facilities.

```{r}
plot_histogram(target_vars)
```

From the plots, we can see that most censuses have 0 to 2 pharmacies in the area, 0 to 4 schools, and 0 to 1 transport POS. It is also noted that all 3 graphs are skewed to the right, suggesting that the distribution of facilities are not normal.

The graph storngly indicate that some censuses might be lacking facilities in their areas. We will continue to explore the data set to identify possible variables contributing to this lack of facilities.

### Numerical Data

```{r}
df_num <- df %>% 
  select(where(is.numeric)) %>% 
  select(-index)
```

```{r}
#histogram
plot_histogram(df_num)
```

-   Normal: avg_age, population, expense_home

-   Should we normalize other variables (nationality, etc.) ?

It is noted that different censuses seem to have different concentration of age, income, population, and foreigners - spaniards percentage. These might be important factors influencing the number of facilities in each census.

```{r}
cor_df <- df %>% 
  select(n_pharmacies, n_schools, n_transport_salespoints, avg_age, family_income, population,pcg_foreigners)

plot_correlation(cor_df)
```

It seems that these variables do not have high correlation with the targeted variables. The only noticeable ones are number of schools and average age (-0.2), number of schools and family income (0.18), number of schools and population (0.32), and number of transport POS and percentage of foreigners (0.16). It makes sense that older communities would not need schools in their area and areas with more people would need more schools. Foreigners may also move around the city more for sightseeing and visiting around so they would need more access to transport sales points.

## Feature selection

### Filtering

```{r}
df %>% distinct(province_code)
```

Province_code also only has 1 observation, therefore, will also not be useful for the model.

```{r}
par(mfrow = c(1,2))
plot(df$foreigners)
plot(df$pcg_foreigners)
```

Foreginers and pcg_foreigners have the same values, thus, we will only need to include one of them in the model.

```{r}
par(mfrow = c(1,2))
plot(df$population/df$area)
plot(df$population_density)
```

Since density is calculated by dividing the population by its area, we do not need population density in the model since it represents the information that could be given by area and population.

```{r}
df_selected <- df %>% 
  select(-c(index, province_code, pcg_foreigners, centroid, geometry, population_density))
```

Index is irrelevant for predicting model so we will drop it. The data set already has area so centroid will not be much of help. Similarly, geometry might not be necessary for the model.

### Pearson's Correlation

```{r}
# TO DO: discard variables poorly related to target variables
cor_rank <- function(data, col) {
  cor<- cor(data, method = "pearson") %>% 
  data.frame() %>% 
  round(.,2) %>% 
  select(all_of(col)) %>% 
  filter(!(rownames(.) %in% c("n_pharmacies", "n_transport_salespoints", "n_schools")))
  cor <- arrange(cor, desc(ifelse(cor[[col]] < 0, cor[[col]] * (-1), cor[[col]])))
  return(cor)
}

cor_df_pharmacy <- cor_rank(df_num, "n_pharmacies")
cor_df_pharmacy

cor_df_school <- cor_rank(df_num, "n_schools")
cor_df_school

cor_df_transport <- cor_rank(df_num, "n_transport_salespoints")
cor_df_transport


```

# Feature engineering

```{r}
# TO DO
```

# Regression models

```{r}
# TO DO
```

## Score generation

```{r}
# TO DO
```

# Result analysis and visualization

```{r}
# TO DO
```
