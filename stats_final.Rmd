---
author: "Phong Duong - 100500507"
title: "Data Science II - Assignment"
output: html_document
---

# Libraries

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(data.table)
library(tidyverse)
library(DataExplorer)
library(caret) 
library(Metrics)
library(MASS)
library(e1071)
```

# Problem description

In our cities, there are some services that are essential for our daily living: **pharmacies, schools or transport points of sale.** However, these facilities are not necessarily well distributed. We want to analyze in this assignment which areas lacks of these facilities based on regression models. The steps to perform the analysis are:

-   Do a descriptive analysis of data
-   Are there variables we can discard?
-   Perform a feature engineering process extending important variables.
-   Perform regression modelling for the three target variables (three different models).
-   Create a score to measure **which areas** have enough facilities and which ones don't.
-   Which variables are the most highly related to the score? In particular, what makes a census section to have a low number of facilities?
-   Visualize and discuss the results

# Dataset description

```{r}
df<-fread("census_section_stats.csv", sep=";", dec=",", stringsAsFactors = F)
head(df)
```

For every census section we have a row in our dataset, here are some of the main columns of the dataset: \* census_section_code: census_section_code identifier \* n_pharmacies (target variable 1): number of pharmacies in the census section \* n_schools (target variable 2): number of schools in the census section \* n_transport_salespoints: number of transport points of sale.

# Descriptive analysis

## Data Exploration

### Brief Check of overall data

```{r}
str(df)
summary(df)
```

No missing data (NA)

```{r}
#Convert to appropriate data type
df <- df %>% 
  mutate(
    census_section_code = as.character(census_section_code),
    census_district_code = as.character(census_district_code),
    city_code = as.character(city_code),
    province_code = as.character(province_code)
  )
```

### **Target variables**

-   Pharmacy - each census on average has 1 pharmacy, max = 5 --\> check if income affects this

-   School - each census has around 1 school, max = 12 --\> check these high values

-   transport - seems like many censuses lack sales points --\> geography might affect this?

```{r}
target_vars <- df %>% 
  select(n_pharmacies, n_schools, n_transport_salespoints)

summary(target_vars)
```

The average number of **pharmacies** in each census is 0.66 (median = 1) with range of 0 to 5. The average number of **schools** in each census is 0.91 (median = 0) and there are anywhere between 0 and 12 school in the censuses. The average number of number of **transport POS** is 0.27 (median = 0) and range from 0 to 4.

It seems that about 50% of the censuses lack a pharmacy, school, and transport sales point, meaning that people living in these censuses would have to go to another location to get access to these services. Some censuses, however, have an excess of facilities.

```{r}
plot_histogram(target_vars)
```

From the plots, we can see that most censuses have 0 to 2 pharmacies in the area, 0 to 4 schools, and 0 to 1 transport POS.

The graph strongly indicate that some censuses might be lacking facilities in their areas. We will continue to explore the data set to identify possible variables contributing to this lack of facilities.

It is also noted that all 3 graphs are skewed to the right, suggesting that the distribution of facilities are not normal. Since the variables are discreet and non-negative, a poisson regression might be a good fit for the model. We can check the first assumption (equidispersion) to see if it's a potential fit.

```{r}
data.frame(
  mean = c(mean(df$n_pharmacies), mean(df$n_schools), mean(df$n_transport_salespoints)),
  var = c(var(df$n_pharmacies), var(df$n_schools), var(df$n_transport_salespoints)),
  row.names = c("pharmacy", "school", "transport")
)
```

It seems that the target variables have similar mean and variance, this could indicate a call for poisson regression model. Although school has variance \> mean, which is case of overdispersion, we can still use different methods to improve the model such as a Quasi-poisson Regression.

### Numerical Data

```{r}
df_num <- df %>% 
  select(where(is.numeric)) %>% 
  select(-index)
```

```{r}
#histogram
plot_histogram(df_num)
```

It is noted that different censuses seem to have different concentration of age, income, population, and foreigners - spaniards percentage. These might be important factors influencing the number of facilities in each census.

### Bivariate Analysis

```{r}
plot_boxplot(df_num, by = "n_pharmacies")
```

```{r}
plot_boxplot(df_num, by = "n_schools")
```

```{r}
plot_boxplot(df_num, by = "n_transport_salespoints")
```

### Correlation Analysis

```{r}
#Correlation Matrix
cor_matrix <- cor(df_num)

findCorrelation(
  cor_matrix,
  cutoff = 0.6,
  verbose = T,
  names = T,
  exact = T
)
```

```{r}
cor_rank <- function(data, col) {
  cor<- cor(data, method = "pearson") %>% 
  data.frame() %>% 
  round(.,2) %>% 
  select(all_of(col)) %>% 
  filter(!(rownames(.) %in% c("n_pharmacies", "n_transport_salespoints", "n_schools")))
  cor <- arrange(cor, desc(ifelse(cor[[col]] < 0, cor[[col]] * (-1), cor[[col]])))
  return(cor)
}

cor_df_pharmacy <- cor_rank(df_num, "n_pharmacies")
cor_df_pharmacy
```

It seems that the percentage of Italian in the census has the highest correlation to the number of pharmacies in the area. Although, it might not make logical sense, sometimes cultural factors have a lot of influence of the distribution of facilities in a city. City_population, population and income_per_capita are the next top variables correlated to the number of pharmacies. It is normal to think that these are relevant as more populated areas would need more facilities. It is worth noting that city_population and population might produce multicolinearity as they one influences the other so we might need to remove one of them. Some variables have very low (close to 0) correlation so we might consider removing them for the model accuracy.

```{r}
cor_df_school <- cor_rank(df_num, "n_schools")
cor_df_school
```

For number of schools, population density have quite high correlation (-0.44) and so does population (0.32). It makes sense that larger population might need more schools and high population density area would indicate less area for building schools. Younger age group percentage (0-24) also has some positive correlation to school, which makes sense as this group of population demands for education.

```{r}
cor_df_transport <- cor_rank(df_num, "n_transport_salespoints")
cor_df_transport
```

It seems that foreigner and non-foreigner (spanish) population are correlated to the distribution of number of transport sales points. It is noted that foreigners and pcg_foreigners might be identical so we will only use one of them to build the model.

### Zero Variance Variables

```{r}
nearZeroVar(df, saveMetrics = TRUE) %>% filter(nzv == TRUE | zeroVar == TRUE) 
```

## Feature selection

```{r}
df %>% distinct(province_code)
```

Province_code also only has 1 observation, therefore, will also not be useful for the model.

```{r}
cor(df$foreigners, df$pcg_foreigners)
```

Foreginers and pcg_foreigners have the same values, thus, we will only need to include one of them in the model.

```{r}
selected_features <- df %>% 
  select(-c(index, province_code, census_section_code, census_district_code, city_code, pcg_foreigners, geometry, centroid))
```

Index is irrelevant for predicting model so we will drop it. The data set already has area so geometry will not be much of help.

# Feature engineering

```{r}
#Extracting latitude and longitude from centroid
selected_features %>% 
  mutate(centroid = str_extract_all(centroid, "\\d+.\\d+")) %>% 
  unnest_wider(col = c(centroid), names_sep = "_") %>% 
  rename(lat = centroid_1, long = centroid_2) %>% 
  mutate(lat = as.numeric(lat), long = as.numeric(long))
```

```{r}
selected_features %>% 
  mutate(
    age_bin = cut(avg_age, breaks = c(0, 25, 40, 50, 60, 70, 100))
  ) %>% 
  relocate(age_bin, .after = avg_age) 
```

```{r}
fe_df <- selected_features %>% 
  mutate(
    population_2 = population**2,
    population_density_2 = population_density**2,
    city_population_2 = city_population**2,
    family_income_2 = family_income**2,
    income_per_capita_2 = income_per_capita**2,
    avg_age_2 = avg_age**2,
    foreigners_2 = foreigners**2
  )
```

We hypothesise that as population increases the facilities should also increase as the need and demand would be higher. Income could also affect the number of facilities as the census would have more capital to build facilities. We also found some correlation between age and number of schools as the younger age group would need access to schools, meaning more schools needed in the area. Finally, we also found some correlation between foreigner percentage and number of transport sales points, indicating cultural influence on facility distribution. We expect that the relationship between these variables and our target variables have a cap (as each census can only hold a certain maximum people depending on their layout and size). Therefore, we create a quadratic term for each of those variables to see if they will help our model.

# Regression models

## Baseline Model

```{r}
toTrain <- createDataPartition(fe_df$n_pharmacies, p = .80, list = FALSE)

trainData <- fe_df[toTrain,]
testData <- fe_df[-toTrain,]

error_summary <- function(test, predict) {
  mse <- mse(test, predict)
  mae <- mae(test, predict)
  data.frame(
    values = c(mse, mae),
    row.names = c("MSE", "MAE")
  )
}
```

### Pharmacy

```{r}
error_summary(testData$n_pharmacies, mean(trainData$n_pharmacies))
```

### School

```{r}
error_summary(testData$n_schools, mean(train_b$n_schools))
```

### Transport POS

```{r}
error_summary(testData$n_transport_salespoints, mean(train_b$n_transport_salespoints))
```

## Regression Models

### Pharmacy

```{r}
set.seed(100507500)

#Train model
train_control <- trainControl(method = "cv", number = 10)

#Linear Model
lm_fit_pharmacy <- train(n_pharmacies ~ ., data = trainData, 
                method = "lm", 
                trControl = train_control)

lm_fit_pharmacy

#Poisson model
poisson_fit_pharmacy <- train(n_pharmacies ~ ., data = trainData,
                              method = "glm", family = "poisson",
                              trControl = train_control)
poisson_fit_pharmacy

#Quasi-Poisson
quasi_poisson_fit_pharmacy <- train(n_pharmacies ~ ., data = trainData,
                              method = "glm", family = "quasi",
                              trControl = train_control)

quasi_poisson_fit_pharmacy
#Lasso Regression
#Ridge Regression
#Elastic Net
elasticnet_fit_pharmacy <- train(n_pharmacies ~ ., data = trainData, 
                method = "glmnet", 
                trControl = train_control)

elasticnet_fit_pharmacy
```

```{r}
#Compare model performance on trainData
results <- resamples(list(linear = lm_fit_pharmacy, 
                          poisson = poisson_fit_pharmacy,
                          quasi_poisson = quasi_poisson_fit_pharmacy, 
                          elasticNet = elasticnet_fit_pharmacy))
summary(results)

bwplot(results, scales = list(x=list(relation="free"), y=list(relation="free")))
```

On train data, lm performs better than the rest.

```{r}
#Importance variables
tibble(
  lm = rownames(varImp(lm_fit_pharmacy)$importance)[1:20],
  poisson = rownames(varImp(poisson_fit_pharmacy)$importance)[1:20],
  quasi_poisson = rownames(varImp(quasi_poisson_fit_pharmacy)$importance)[1:20],
  elasticNet = rownames(varImp(elasticnet_fit_pharmacy)$importance)[1:20]
)
```

Most important variables: area, population, family income, income per capita, average age, and spanish percentage.

```{r}
#Predict on testData
test_phar <- testData %>% mutate(
  pred_lm = predict(lm_fit_pharmacy, testData),
  pred_poisson = predict(poisson_fit_pharmacy, testData),
  pred_quasipoisson = predict(quasi_poisson_fit_pharmacy, testData),
  pred_elasticNet = predict(elasticnet_fit_pharmacy, testData)
)
test_phar %>% select(n_pharmacies,contains("pred"))
```

```{r}
#Compare model performance on testData
list(
  lm = mae(test_phar$pred_lm, test_phar$n_pharmacies),
  poisson = mae(test_phar$pred_poisson, test_phar$n_pharmacies),
  quasi_poisson = mae(test_phar$pred_quasipoisson, test_phar$n_pharmacies),
  elasticNet = mae(test_phar$pred_elasticNet, test_phar$n_pharmacies)
)
```

On test data, lm and quasi_poisson performs better.

### School

```{r}

```

### Transport POS

```{r}

```

## Score generation

```{r}
# TO DO
```

# Result analysis and visualization

```{r}
# TO DO
```
